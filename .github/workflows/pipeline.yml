name: Build, Test and Deploy

on:
  #push:
  #  branches:
  #    - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet Packages
        run: nuget restore FabrikamFiber.CallCenter.sln

      - name: Build Solution
        run: msbuild FabrikamFiber.CallCenter.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="${{ github.workspace }}\WebDeploy" /p:AutoParameterizationWebConfigConnectionStrings=false

      - name: Run Tests
        uses: microsoft/vstest-action@v1.0.0
        with:
          testAssembly: FabrikamFiber.Web.Tests.dll
          searchFolder: ${{ github.workspace }}\FabrikamFiber.Web.Tests\bin\Release\

      - name: Run Tests
        run: |
          & "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" "$($env:GITHUB_WORKSPACE)\FabrikamFiber.Web.Tests\bin\Release\FabrikamFiber.Web.Tests.dll" /TestCaseFilter:"TestCategory=Required" /EnableCodeCoverage

      - name: Archive WebDeploy
        uses: actions/upload-artifact@v4
        with:
          name: WebApp
          path: ${{ github.workspace }}\WebDeploy

      - name: Archive DACPAC
        uses: actions/upload-artifact@v4
        with:
          name: DacPac
          path: '**/FabrikamFiber.Database/bin/Release/*.dacpac'

      - name: Archive Selenium Content
        uses: actions/upload-artifact@v4
        with:
          name: Selenium
          path: |
            **/FabrikamFiber.Web.PureSeleniumTests/bin/Release/**
            **/*.testsettings
            **/*.runsettings

  deploy_qa:
    needs: build
    runs-on: windows-latest
    environment: QA
    steps:
      - name: Download WebApp
        uses: actions/download-artifact@v4
        with:
          name: WebApp
          path: ./WebApp

      - name: Download DacPac
        uses: actions/download-artifact@v4
        with:
          name: DacPac
          path: ./DACPAC

      - name: Deploy to QA
        run: |
          echo "Exemplo de implantação .NET Framework 4.8 em QA..."
          # Scripts de PowerShell/MSBuild/etc. para IIS e SQL

  deploy_prod:
    needs: deploy_qa
    runs-on: windows-latest
    environment: PROD
    steps:
      - name: Download WebApp
        uses: actions/download-artifact@v4
        with:
          name: WebApp
          path: ./WebApp

      - name: Download DacPac
        uses: actions/download-artifact@v4
        with:
          name: DacPac
          path: ./DACPAC

      - name: Deploy to PROD
        run: |
          echo "Exemplo de implantação .NET Framework 4.8 em PROD..."
          # Scripts de PowerShell/MSBuild/etc. para IIS e SQL